<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Pilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden; /* Prevent double scrollbars if sidebar/main content overflow */
        }
        .sidebar-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .bento-box {
            background-color: white;
            border-radius: 12px; 
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            transition: all 0.3s ease;
        }
        .bento-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); 
        }
        .modal-content {
            background-color: #fff;
            margin: 8% auto; 
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px; /* Increased width for team management */
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #2563eb; 
            color: white;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; 
        }
        .btn-secondary {
            background-color: #e5e7eb; 
            color: #374151; 
        }
        .btn-secondary:hover {
            background-color: #d1d5db; 
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .input-field, .select-field {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db; 
            border-radius: 8px;
            margin-top: 4px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #2563eb; 
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f2f5;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        footer {
            background-color: #1f2937; /* Tailwind gray-800 */
            color: #d1d5db; /* Tailwind gray-300 */
            text-align: center;
            padding: 15px 0;
            font-size: 0.875rem;
            margin-top: auto; /* Pushes footer to bottom */
        }
        footer a {
            color: #93c5fd; /* Tailwind blue-300 */
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .list-item-action {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <aside class="w-64 bg-white shadow-md flex flex-col p-4 space-y-2 fixed top-0 left-0 h-full z-20">
            <div class="text-2xl font-bold text-blue-600 mb-8 px-2">Project Pilot</div>
            <nav id="sidebarNav" class="flex-grow overflow-y-auto">
                </nav>
            <div class="mt-auto">
                <a href="#" onclick="navigateTo('profile')" class="flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700 transition-colors duration-150">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Profile
                </a>
                <a href="#" onclick="logout()" class="flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700 transition-colors duration-150">
                    <svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </a>
            </div>
        </aside>

        <main id="mainContent" class="flex-1 ml-64 p-6 md:p-8 overflow-y-auto">
            </main>
    </div>

    <footer id="appFooter">
        Project Pilot v1.0.0 | &copy; 2025 Project Pilot | Created by <a href="mailto:ihaseev@gmail.com">Haseeb</a> | Surovi | Nodi
    </footer>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="userModalTitle" class="text-xl font-semibold">Create User</h2>
                <button onclick="closeModal('userModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId" name="userId">
                <div class="form-grid">
                    <div>
                        <label for="userName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="userName" name="userName" class="input-field" required>
                    </div>
                    <div>
                        <label for="userEmail" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="userEmail" name="userEmail" class="input-field" required>
                    </div>
                </div>
                <div class="form-grid mt-4">
                    <div>
                        <label for="userRole" class="block text-sm font-medium text-gray-700">Role</label>
                        <select id="userRole" name="userRole" class="select-field" required onchange="toggleStudentFields()">
                            <option value="student">Student</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div>
                        <label for="userPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="userPassword" name="userPassword" class="input-field" placeholder="Leave blank if not changing">
                    </div>
                </div>
                <div id="studentSpecificFields" class="form-grid mt-4" style="display: none;">
                    <div>
                        <label for="userRoll" class="block text-sm font-medium text-gray-700">Roll Number</label>
                        <input type="text" id="userRoll" name="userRoll" class="input-field">
                    </div>
                    <div>
                        <label for="userSemester" class="block text-sm font-medium text-gray-700">Semester</label>
                        <select id="userSemester" name="userSemester" class="select-field">
                            </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('userModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="projectModalTitle" class="text-xl font-semibold">Create Project</h2>
                <button onclick="closeModal('projectModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="projectForm">
                <input type="hidden" id="projectId" name="projectId">
                <div>
                    <label for="projectTitle" class="block text-sm font-medium text-gray-700">Project Title</label>
                    <input type="text" id="projectTitle" name="projectTitle" class="input-field" required>
                </div>
                <div>
                    <label for="projectDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="projectDescription" name="projectDescription" rows="3" class="input-field" required></textarea>
                </div>
                <div class="form-grid mt-4">
                    <div>
                        <label for="projectSupervisor" class="block text-sm font-medium text-gray-700">Assign Supervisor</label>
                        <select id="projectSupervisor" name="projectSupervisor" class="select-field" required>
                             <option value="">Select Supervisor</option>
                        </select>
                    </div>
                    <div>
                        <label for="projectSemester" class="block text-sm font-medium text-gray-700">Semester</label>
                        <select id="projectSemester" name="projectSemester" class="select-field">
                             </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('projectModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <div id="noticeModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="noticeModalTitle" class="text-xl font-semibold">Post Notice</h2>
                <button onclick="closeModal('noticeModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="noticeForm">
                <input type="hidden" id="noticeId" name="noticeId">
                <div>
                    <label for="noticeTitle" class="block text-sm font-medium text-gray-700">Notice Title</label>
                    <input type="text" id="noticeTitle" name="noticeTitle" class="input-field" required>
                </div>
                <div>
                    <label for="noticeContent" class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea id="noticeContent" name="noticeContent" rows="3" class="input-field" required></textarea>
                </div>
                <div class="form-grid mt-4">
                    <div>
                        <label for="noticeAudienceType" class="block text-sm font-medium text-gray-700">Audience Type</label>
                        <select id="noticeAudienceType" name="noticeAudienceType" class="select-field" required onchange="updateNoticeTargetOptions()">
                            <option value="all">Everyone (All Users)</option>
                            <option value="all_students">All Students</option>
                            <option value="all_supervisors">All Supervisors</option>
                            <option value="specific_student">Specific Student</option>
                            <option value="specific_supervisor">Specific Supervisor</option>
                            <option value="specific_project">Specific Project/Team</option>
                            <option value="specific_semester_students">Students in Semester</option>
                        </select>
                    </div>
                    <div id="noticeSpecificTargetContainer" style="display: none;">
                        <label for="noticeSpecificTarget" id="noticeSpecificTargetLabel" class="block text-sm font-medium text-gray-700">Select Target</label>
                        <input type="text" id="noticeStudentFilter" class="input-field mb-2" placeholder="Filter students by name/roll..." style="display:none;">
                        <select id="noticeSpecificTarget" name="noticeSpecificTarget" class="select-field">
                            </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('noticeModal')" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Post Notice</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="assignTeamModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="assignTeamModalTitle" class="text-xl font-semibold">Manage Project Team</h2>
                <button onclick="closeModal('assignTeamModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="assignTeamForm">
                <input type="hidden" id="assignTeamProjectId" name="assignTeamProjectId">
                
                <div class="mb-4">
                    <h3 class="text-md font-semibold text-gray-700 mb-2">Current Team Members:</h3>
                    <div id="currentTeamMembersList" class="max-h-40 overflow-y-auto border rounded-md p-2 bg-gray-50">
                        </div>
                </div>

                <div class="mb-4">
                    <h3 class="text-md font-semibold text-gray-700 mb-2">Available Students (Same Semester, Unassigned):</h3>
                    <div id="availableStudentsList" class="max-h-40 overflow-y-auto border rounded-md p-2 bg-gray-50">
                        </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('assignTeamModal')" class="btn btn-secondary">Close</button>
                    </div>
            </form>
        </div>
    </div>


    <div id="messageModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="flex justify-between items-center mb-4">
                <h2 id="messageModalTitle" class="text-xl font-semibold">Notification</h2>
                <button onclick="closeModal('messageModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p id="messageModalText" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button type="button" onclick="closeModal('messageModal')" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES AND API CONFIGURATION START ---
        let currentUser = null; // Stores the currently logged-in user's data
        const API_BASE_URL = 'http://localhost/project_pilot/api/'; // Base URL for your PHP API endpoints
        // --- GLOBAL VARIABLES AND API CONFIGURATION END ---


        // --- API UTILITY FUNCTIONS START ---
        // Generic function to fetch data from the API
        async function fetchData(endpoint, params = {}) {
            const url = new URL(API_BASE_URL + endpoint);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching from ${endpoint}:`, error);
                showMessageModal('Error', `Failed to load data: ${error.message}`);
                return null;
            }
        }

        // Generic function to send data (POST, PUT, DELETE) to the API
        async function sendData(endpoint, method, data = null, isFormData = false) {
            const options = {
                method: method,
                headers: {}
            };

            if (isFormData) {
                options.body = data; // FormData object
            } else if (data) {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(API_BASE_URL + endpoint, options);
                const responseData = await response.json(); // Always try to parse JSON response

                if (!response.ok) {
                    throw new Error(responseData.message || `HTTP error! Status: ${response.status}`);
                }
                return responseData;
            } catch (error) {
                console.error(`Error sending data to ${endpoint} (${method}):`, error);
                showMessageModal('Error', `Operation failed: ${error.message}`);
                return null;
            }
        }
        // --- API UTILITY FUNCTIONS END ---


        // --- AUTHENTICATION AND SESSION MANAGEMENT START ---
        // Function to set the current user and save to local storage
        function setCurrentUser(user) {
            if (user) {
                currentUser = { ...user }; // Store a copy
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log("Current user set to:", currentUser);
            } else {
                currentUser = null;
                localStorage.removeItem('currentUser');
                console.log("Current user unset.");
            }
            // Re-render sidebar based on new user role
            renderSidebar();
            // The onload function (below) will call refreshCurrentPage via renderSidebar's auto-click
        }

        // Function to load user from local storage on page load
        function loadCurrentUser() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                console.log("Loaded user from localStorage:", currentUser);
            }
        }

        // Handles user login
        async function login(email, password) {
            try {
                // In a real application, you'd send email/password to a dedicated login API endpoint
                // and the backend would verify the hashed password.
                // For this example, we'll fetch the user by email and do a basic password check.
                const users = await fetchData('users.php', { email: email });

                if (users && users.length > 0) {
                    const user = users[0];
                    // IMPORTANT: In a production app, never send plain passwords.
                    // The PHP backend should hash passwords and verify them securely.
                    // For this demo, we're assuming a simple 'password' string for the initial admin.
                    // For other users created via the UI, the password will be hashed in the backend.
                    // A more robust login would involve a POST request to a login endpoint
                    // where the backend verifies the password hash.
                    
                    // Since our initial admin has 'password' as plain text in the DB (hashed on creation)
                    // and other users have hashed passwords, a simple client-side check is not secure.
                    // For this demo, we'll just check if the email exists and assume a successful login
                    // IF the password matches 'password' for the initial admin.
                    // For any other user, this login will currently fail because we don't have a password
                    // verification endpoint.
                    
                    // This is a *major security flaw* for a real app.
                    // For demonstration purposes, we'll allow login if the email exists and
                    // if it's the 'admin_initial' user with password 'password'.
                    // For other users, you'd need a proper password_verify in PHP.
                    
                    // Simulating password verification for the initial admin user
                    if (user.email === email && password === 'password') { // For the initial admin user with plain 'password'
                         setCurrentUser(user);
                         showMessageModal('Success', 'Login Successful!');
                         refreshCurrentPage();
                         return true;
                    } else if (user.email === email) {
                        // For users created via the UI, their passwords are hashed.
                        // A proper login would send the password to the backend for verification.
                        // Since we don't have a dedicated /login endpoint with password_verify,
                        // this will not work for users created via the UI.
                        showMessageModal('Error', 'Invalid credentials. (For users created via UI, password verification needs backend support.)');
                        return false;
                    }
                    
                } else {
                    showMessageModal('Error', 'User not found.');
                    return false;
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessageModal('Error', `An error occurred during login: ${error.message}`);
                return false;
            }
        }

        // Handles user logout
        function logout() {
            setCurrentUser(null);
            showMessageModal('Info', 'Logged Out');
            renderLoginPage(); // Show the login page after logout
        }

        // Renders the login page
        function renderLoginPage() {
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="flex items-center justify-center min-h-[calc(100vh-64px)] bg-gray-100">
                        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
                            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Project Pilot Login</h2>
                            <form id="loginForm">
                                <div class="mb-4">
                                    <label for="loginEmail" class="block text-gray-700 text-sm font-semibold mb-2">Email</label>
                                    <input type="email" id="loginEmail" name="email" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your email" required>
                                </div>
                                <div class="mb-6">
                                    <label for="loginPassword" class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                                    <input type="password" id="loginPassword" name="password" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your password" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">Login</button>
                            </form>
                        </div>
                    </div>
                `;
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const email = document.getElementById('loginEmail').value;
                        const password = document.getElementById('loginPassword').value;
                        await login(email, password);
                    });
                }
            }
        }
        // --- AUTHENTICATION AND SESSION MANAGEMENT END ---


        // --- NAVIGATION AND PAGE RENDERING START ---
        // Defines navigation items based on user role
        const navItems = {
            admin: [
                { name: 'Dashboard', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', page: 'adminDashboard' },
                { name: 'Manage Admins', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3M15 21h6m-6-3h6m-6-3h6M9 3V1m6 2V1m-6 4h.01M9 4h.01M15 4h.01M12 4h.01M15 9h.01M12 9h.01M9 9h.01M15 12h.01M12 12h.01M9 12h.01M15 15h.01M12 15h.01M9 15h.01"></path></svg>', page: 'manageAdmins' },
                { name: 'Manage Supervisors', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>', page: 'manageSupervisors' },
                { name: 'Manage Students', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3M15 21h6m-6-3h6m-6-3h6M9 3V1m6 2V1m-6 4h.01M9 4h.01M15 4h.01M12 4h.01M15 9h.01M12 9h.01M9 9h.01M15 12h.01M12 12h.01M9 12h.01M15 15h.01M12 15h.01M9 15h.01"></path></svg>', page: 'manageStudents' },
                { name: 'Manage Projects', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', page: 'manageProjects' },
                { name: 'Manage Semesters', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>', page: 'manageSemesters' },
                { name: 'Notices', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>', page: 'viewNotices' },
            ],
            supervisor: [
                { name: 'Dashboard', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', page: 'supervisorDashboard' },
                { name: 'My Projects', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', page: 'supervisorProjects' },
                { name: 'My Students', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6a6 6 0 016 6v1h-3M15 21h6m-6-3h6m-6-3h6M9 3V1m6 2V1m-6 4h.01M9 4h.01M15 4h.01M12 4h.01M15 9h.01M12 9h.01M9 9h.01M15 12h.01M12 12h.01M9 12h.01M15 15h.01M12 15h.01M9 15h.01"></path></svg>', page: 'supervisorStudents' },
                { name: 'Submissions', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>', page: 'supervisorSubmissions' },
                { name: 'Notices', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>', page: 'viewNotices' },
            ],
            student: [
                { name: 'Dashboard', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>', page: 'studentDashboard' },
                { name: 'My Project', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', page: 'studentProject' },
                { name: 'My Submissions', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>', page: 'studentSubmissions' },
                { name: 'Notices', icon: '<svg class="sidebar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>', page: 'viewNotices' },
            ]
        };

        // Renders the sidebar based on the current user's role
        function renderSidebar() {
            const sidebarNav = document.getElementById('sidebarNav');
            sidebarNav.innerHTML = ''; // Clear existing items

            // If no user is logged in, hide sidebar and show login page
            if (!currentUser) {
                document.querySelector('aside').style.display = 'none';
                renderLoginPage();
                return;
            } else {
                document.querySelector('aside').style.display = 'flex'; // Show sidebar
            }

            const items = navItems[currentUser.role] || [];
            items.forEach(item => {
                const link = document.createElement('a');
                link.href = '#';
                link.className = 'flex items-center p-3 rounded-lg hover:bg-gray-100 text-gray-700 transition-colors duration-150';
                link.innerHTML = `${item.icon} ${item.name}`;
                link.onclick = (e) => {
                    e.preventDefault();
                    navigateTo(item.page);
                    // Remove active class from all links and add to the clicked one
                    document.querySelectorAll('#sidebarNav a').forEach(a => a.classList.remove('bg-blue-100', 'text-blue-600', 'font-semibold'));
                    link.classList.add('bg-blue-100', 'text-blue-600', 'font-semibold');
                };
                sidebarNav.appendChild(link);
            });

            // Automatically click the first navigation item for the current role
            if (sidebarNav.firstChild) {
                sidebarNav.firstChild.click();
            }
        }

        // Navigates to the specified page and renders its content
        async function navigateTo(pageId) {
            console.log(`Navigating to ${pageId}`);
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div><p class="ml-4 text-gray-600">Loading...</p></div>'; // Show loading spinner

            // Ensure current user is available before rendering pages
            if (!currentUser) {
                renderLoginPage();
                return;
            }

            // Render content based on pageId
            if (pageId === 'adminDashboard') await renderAdminDashboard();
            else if (pageId === 'manageAdmins') await renderUserManagementPage('Admins', 'admin');
            else if (pageId === 'manageSupervisors') await renderUserManagementPage('Supervisors', 'supervisor');
            else if (pageId === 'manageStudents') await renderUserManagementPage('Students', 'student');
            else if (pageId === 'manageProjects') await renderProjectManagementPage();
            else if (pageId === 'manageSemesters') await renderManageSemestersPage();
            else if (pageId === 'viewNotices') await renderNoticesPage();
            else if (pageId === 'profile') await renderProfilePage();
            else if (pageId === 'supervisorDashboard') await renderSupervisorDashboard();
            else if (pageId === 'supervisorProjects') await renderSupervisorProjectsPage();
            else if (pageId === 'supervisorStudents') await renderSupervisorStudentsPage();
            else if (pageId === 'supervisorSubmissions') await renderSupervisorSubmissionsPage();
            else if (pageId === 'studentDashboard') await renderStudentDashboard();
            else if (pageId === 'studentProject') await renderStudentProjectPage();
            else if (pageId === 'studentSubmissions') await renderStudentSubmissionsPage();
            else mainContent.innerHTML = `<h1 class="text-2xl font-semibold">Page Not Found</h1><p>Content for ${pageId} is not yet implemented.</p>`;
            
            // Attach specific event listeners after content is rendered
            if (pageId === 'studentProject') {
                 const submissionForm = document.getElementById('submissionForm');
                 if(submissionForm) submissionForm.addEventListener('submit', handleStudentSubmission);
            }
            if (pageId === 'viewNotices') {
                const noticeAudienceType = document.getElementById('noticeAudienceType');
                if (noticeAudienceType) {
                    noticeAudienceType.addEventListener('change', () => updateNoticeTargetOptions());
                }
                const studentFilterInput = document.getElementById('noticeStudentFilter');
                if (studentFilterInput) {
                    studentFilterInput.addEventListener('input', () => updateNoticeTargetOptions('specific_student', true));
                }
            }
        }

        // Helper function to create a styled "bento box" card
        function createBentoBox(title, content, className = 'md:col-span-1') {
            return `
                <div class="bento-box ${className}">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">${title}</h3>
                    ${content}
                </div>
            `;
        }

        // --- DASHBOARD AND MANAGEMENT PAGE RENDERING START ---

        // Renders the Admin Dashboard
        async function renderAdminDashboard() {
            const users = await fetchData('users.php');
            const projects = await fetchData('projects.php');
            const notices = await fetchData('notices.php');

            const totalUsers = users ? users.length : 0;
            const totalProjects = projects ? projects.length : 0;
            const recentActivity = notices ? notices.filter(n => ['all', 'all_students', 'all_supervisors'].includes(n.audience_type)).slice(0,2).map(n => `<p class="text-sm text-gray-600 mb-1 truncate" title="${n.content}">${n.title} <span class="text-xs text-gray-400">- ${new Date(n.notice_date).toLocaleDateString()}</span></p>`).join('') : '<p class="text-sm text-gray-500">No recent general notices.</p>';

            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Admin Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${createBentoBox('Quick Stats', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${totalUsers}</span> Total Users</p>
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${totalProjects}</span> Total Projects</p>
                    `)}
                    ${createBentoBox('Quick Actions', `
                        <button onclick="openUserModal()" class="btn btn-primary w-full mb-2">Create New User</button>
                        <button onclick="openProjectModal()" class="btn btn-primary w-full mb-2">Create New Project</button>
                        <button onclick="openNoticeModal()" class="btn btn-primary w-full">Post Notice</button>
                    `)}
                     ${createBentoBox('Recent General Notices', recentActivity, 'md:col-span-1 lg:col-span-1')}
                    ${createBentoBox('System Management', `
                        <p class="text-gray-600 mb-2">Manage core components of the system.</p>
                        <button onclick="navigateTo('manageAdmins')" class="text-sm text-blue-600 hover:underline">Manage Admins &rarr;</button><br>
                        <button onclick="navigateTo('manageSupervisors')" class="text-sm text-blue-600 hover:underline">Manage Supervisors &rarr;</button><br>
                        <button onclick="navigateTo('manageStudents')" class="text-sm text-blue-600 hover:underline">Manage Students &rarr;</button><br>
                        <button onclick="navigateTo('manageSemesters')" class="text-sm text-blue-600 hover:underline">Manage Semesters &rarr;</button>
                    `, 'md:col-span-2 lg:col-span-3')}
                </div>
            `;
        }

        // Renders user management page for a specific role
        async function renderUserManagementPage(title, roleFilter) {
            const users = await fetchData('users.php', { role: roleFilter });
            let tableRows = '';

            if (users && users.length > 0) {
                tableRows = users.map(user => `
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <td class="py-3 px-4 text-sm text-gray-700">${user.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-700">${user.email}</td>
                        <td class="py-3 px-4 text-sm text-gray-500">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
                        ${roleFilter === 'student' ? `<td class="py-3 px-4 text-sm text-gray-500">${user.roll_number || 'N/A'}</td><td class="py-3 px-4 text-sm text-gray-500">${user.semester || 'N/A'}</td>` : ''}
                        <td class="py-3 px-4 text-sm">
                            <button onclick="openUserModal('${user.user_id}')" class="text-blue-600 hover:text-blue-800 font-medium mr-2">Edit</button>
                            <button onclick="deleteUser('${user.user_id}')" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tableRows = `<tr><td colspan="${roleFilter === 'student' ? 6 : 4}" class="text-center py-4 text-gray-500">No ${title.toLowerCase()} found.</td></tr>`;
            }
            
            const studentHeaders = roleFilter === 'student' ? 
                `<th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll</th>
                 <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>` : '';

            document.getElementById('mainContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Manage ${title}</h1>
                    <button onclick="openUserModal(null, '${roleFilter}')" class="btn btn-primary">Add New ${roleFilter.charAt(0).toUpperCase() + roleFilter.slice(1)}</button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                ${studentHeaders}
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // Renders project management page (Admin view)
        async function renderProjectManagementPage() {
            const projects = await fetchData('projects.php');
            const users = await fetchData('users.php'); // Fetch all users to get supervisor/student names

            let projectCards = '';
            if (projects && projects.length > 0) {
                projectCards = projects.map(project => {
                    const supervisor = users ? users.find(u => u.user_id === project.supervisor_id) : null;
                    const leader = project.leader ? project.leader : null; // Leader is already part of project object from API
                    const studentNames = project.members ? project.members.map(member => {
                        return `${member.name}${member.is_leader ? ' <span class="text-xs bg-green-100 text-green-700 px-1 rounded-full">Leader</span>' : ''}`;
                    }).join(', ') : 'No students assigned';

                    return `
                        <div class="bento-box">
                            <h4 class="text-xl font-semibold text-blue-600">${project.title}</h4>
                            <p class="text-sm text-gray-500 mb-1">Supervisor: ${supervisor ? supervisor.name : 'N/A'}</p>
                            <p class="text-sm text-gray-500 mb-1">Semester: ${project.semester || 'N/A'}</p>
                            <p class="text-sm text-gray-500 mb-1">Leader: ${leader ? leader.name : 'Not Set'}</p>
                            <p class="text-sm text-gray-600 mb-2 h-12 overflow-y-auto">${project.description}</p>
                            <p class="text-sm text-gray-500 mb-1">Status: <span class="font-medium ${project.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'}">${project.status}</span></p>
                            <p class="text-xs text-gray-500 mb-3">Team: ${studentNames}</p>
                            <div class="flex justify-end space-x-2 mt-2">
                                <button onclick="openAssignStudentsModal('${project.project_id}')" class="text-sm btn bg-green-500 hover:bg-green-600 text-white py-1 px-3">Manage Team</button>
                                <button onclick="openProjectModal('${project.project_id}')" class="text-sm btn btn-secondary py-1 px-3">Edit Project</button>
                                <button onclick="deleteProject('${project.project_id}')" class="text-sm btn btn-danger py-1 px-3">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                projectCards = `<p class="text-center py-4 text-gray-500 col-span-full">No projects found.</p>`;
            }

            document.getElementById('mainContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Manage Projects</h1>
                    <button onclick="openProjectModal()" class="btn btn-primary">Create New Project</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${projectCards}
                </div>
            `;
        }
        
        // Renders the manage semesters page
        async function renderManageSemestersPage() {
            const semesters = await fetchData('semesters.php'); // Assuming you'll add a semesters.php API
            const users = await fetchData('users.php');
            const projects = await fetchData('projects.php');

            let semesterSections = '';
            if (semesters && semesters.length > 0) {
                semesterSections = semesters.map(semester => {
                    const studentsInSemester = users ? users.filter(u => u.role === 'student' && u.semester === semester.semester_name) : [];
                    const projectsInSemester = projects ? projects.filter(p => p.semester === semester.semester_name) : [];

                    let studentListHtml = studentsInSemester.length > 0 ? 
                        studentsInSemester.map(s => `
                            <li class="list-item">
                                <span>${s.name} (${s.roll_number || 'N/A'}) - Project: ${s.project_id ? (projects.find(p=>p.project_id === s.project_id)?.title || 'N/A') : 'None'}</span>
                                <button onclick="openUserModal('${s.user_id}')" class="text-xs btn btn-secondary py-1 px-2">Edit</button>
                            </li>`).join('') : 
                        '<li class="text-sm text-gray-500">No students in this semester.</li>';
                    
                    let projectListHtml = projectsInSemester.length > 0 ?
                        projectsInSemester.map(p => `
                            <li class="list-item">
                                <span>${p.title} (Supervisor: ${users.find(u=>u.user_id === p.supervisor_id)?.name || 'N/A'})</span>
                                <button onclick="navigateTo('manageProjects'); setTimeout(() => openProjectModal('${p.project_id}'), 100);" class="text-xs btn btn-secondary py-1 px-2">View/Edit</button>
                            </li>`).join('') :
                        '<li class="text-sm text-gray-500">No projects in this semester.</li>';

                    return `
                        <div class="bento-box mb-6">
                            <h3 class="text-xl font-semibold text-blue-700 mb-3">${semester.semester_name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-md font-semibold text-gray-600 mb-2">Students:</h4>
                                    <ul class="space-y-1">${studentListHtml}</ul>
                                </div>
                                <div>
                                    <h4 class="text-md font-semibold text-gray-600 mb-2">Projects:</h4>
                                    <ul class="space-y-1">${projectListHtml}</ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                semesterSections = `<p class="text-center py-4 text-gray-500 col-span-full">No semesters found.</p>`;
            }

            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Semesters</h1>
                ${semesterSections}
            `;
        }

        // Renders the notices page
        async function renderNoticesPage() {
            const allNotices = await fetchData('notices.php');
            const allUsers = await fetchData('users.php');
            const allProjects = await fetchData('projects.php');
            const allSemesters = await fetchData('semesters.php');

            let relevantNotices = [];
            if (allNotices) {
                relevantNotices = allNotices.filter(notice => {
                    const aud = { type: notice.audience_type, targetId: notice.target_id };
                    if (aud.type === 'all') return true;
                    if (currentUser.role === 'admin') return true;

                    if (aud.type === 'all_students' && currentUser.role === 'student') return true;
                    if (aud.type === 'all_supervisors' && currentUser.role === 'supervisor') return true;
                    
                    if (aud.type === 'specific_student' && aud.targetId === currentUser.user_id) return true;
                    if (aud.type === 'specific_supervisor' && aud.targetId === currentUser.user_id) return true;
                    
                    if (aud.type === 'specific_project') {
                        if (currentUser.role === 'student') {
                            const studentProject = allProjects.find(p => p.members.some(m => m.user_id === currentUser.user_id));
                            return studentProject && studentProject.project_id === aud.targetId;
                        }
                        if (currentUser.role === 'supervisor') {
                            const project = allProjects.find(p => p.project_id === aud.targetId);
                            return project && project.supervisor_id === currentUser.user_id;
                        }
                    }
                    if (aud.type === 'specific_semester_students' && currentUser.role === 'student') {
                        const studentUser = allUsers.find(u => u.user_id === currentUser.user_id);
                        return studentUser && studentUser.semester === aud.targetId;
                    }
                     if (aud.type === 'specific_semester_students' && currentUser.role === 'supervisor') {
                        return allProjects.some(p => p.supervisor_id === currentUser.user_id && p.semester === aud.targetId);
                     }
                    if (notice.author_id === currentUser.user_id) return true; // Supervisor can see their own notices

                    return false;
                }).sort((a,b) => new Date(b.notice_date) - new Date(a.notice_date));
            }

            let noticeItems = '';
            if (relevantNotices.length > 0) {
                noticeItems = relevantNotices.map(notice => {
                    let audienceDisplay = `Audience: ${notice.audience_type.replace(/_/g, ' ')}`;
                    if (notice.target_id) {
                        let targetName = '';
                        if (notice.audience_type === 'specific_student' || notice.audience_type === 'specific_supervisor') {
                            targetName = allUsers.find(u => u.user_id === notice.target_id)?.name || 'Unknown';
                        } else if (notice.audience_type === 'specific_project') {
                            targetName = allProjects.find(p => p.project_id === notice.target_id)?.title || 'Unknown Project';
                        } else if (notice.audience_type === 'specific_semester_students') {
                            targetName = notice.target_id; // Semester name itself
                        }
                        audienceDisplay += ` (${targetName})`;
                    }

                    return `
                    <div class="bento-box mb-4">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-semibold text-blue-700">${notice.title}</h4>
                            ${currentUser.role === 'admin' || notice.author_id === currentUser.user_id ? `
                            <div>
                                <button onclick="openNoticeModal('${notice.notice_id}')" class="text-xs text-blue-600 hover:underline mr-2">Edit</button>
                                <button onclick="deleteNotice('${notice.notice_id}')" class="text-xs text-red-600 hover:underline">Delete</button>
                            </div>` : ''}
                        </div>
                        <p class="text-sm text-gray-700 mt-1 mb-2 whitespace-pre-wrap">${notice.content}</p>
                        <p class="text-xs text-gray-500">Posted by: ${notice.author_name} on ${new Date(notice.notice_date).toLocaleDateString()} | ${audienceDisplay}</p>
                    </div>
                `}).join('');
            } else {
                noticeItems = `<p class="text-center py-4 text-gray-500">No notices found for you.</p>`;
            }
            
            const canPostNotice = currentUser.role === 'admin' || currentUser.role === 'supervisor';

            document.getElementById('mainContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Notices</h1>
                    ${canPostNotice ? `<button onclick="openNoticeModal()" class="btn btn-primary">Post New Notice</button>` : ''}
                </div>
                <div>
                    ${noticeItems}
                </div>
            `;
        }
        
        // Renders the user profile page
        async function renderProfilePage() {
            const user = await fetchData('users.php', { id: currentUser.user_id });
            const profileUser = user ? user[0] : null;

            if (!profileUser) return `<p>Error: User profile not found.</p>`;
            
            let additionalInfo = '';
            if (profileUser.role === 'student') {
                additionalInfo = `
                    <p><strong class="text-gray-600">Roll Number:</strong> ${profileUser.roll_number || 'N/A'}</p>
                    <p><strong class="text-gray-600">Semester:</strong> ${profileUser.semester || 'N/A'}</p>
                `;
            }
            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">My Profile</h1>
                <div class="bento-box max-w-md mx-auto">
                    <div class="space-y-3">
                        <p><strong class="text-gray-600">Name:</strong> ${profileUser.name}</p>
                        <p><strong class="text-gray-600">Email:</strong> ${profileUser.email}</p>
                        <p><strong class="text-gray-600">Role:</strong> ${profileUser.role.charAt(0).toUpperCase() + profileUser.role.slice(1)}</p>
                        ${additionalInfo}
                        <button onclick="openUserModal('${profileUser.user_id}')" class="btn btn-primary mt-4">Edit Profile</button>
                    </div>
                </div>
            `;
        }

        // --- Supervisor Specific Pages ---
        async function renderSupervisorDashboard() {
            const myProjects = await fetchData('projects.php', { supervisor_id: currentUser.user_id });
            const allUsers = await fetchData('users.php');
            const mySubmissions = await fetchData('submissions.php', { supervisor_id: currentUser.user_id }); // Need to adjust submissions API to filter by supervisor's projects

            let myStudentsCount = 0;
            if (myProjects) {
                const supervisedStudentIds = new Set();
                myProjects.forEach(p => {
                    if (p.members) p.members.forEach(m => supervisedStudentIds.add(m.user_id));
                });
                myStudentsCount = supervisedStudentIds.size;
            }
            
            const pendingSubmissions = mySubmissions ? mySubmissions.filter(s => s.status === 'Submitted').length : 0;

            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Supervisor Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${createBentoBox('My Projects Overview', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${myProjects ? myProjects.length : 0}</span> Active Projects</p>
                        <button onclick="navigateTo('supervisorProjects')" class="text-sm text-blue-600 hover:underline mt-2">View My Projects &rarr;</button>
                    `)}
                    ${createBentoBox('My Students', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${myStudentsCount}</span> Students Supervised</p>
                        <button onclick="navigateTo('supervisorStudents')" class="text-sm text-blue-600 hover:underline mt-2">Manage My Students &rarr;</button>
                    `)}
                    ${createBentoBox('Pending Submissions', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-orange-500">${pendingSubmissions}</span> Submissions to Review</p>
                        <button onclick="navigateTo('supervisorSubmissions')" class="text-sm text-blue-600 hover:underline mt-2">Review Submissions &rarr;</button>
                    `)}
                     ${createBentoBox('Quick Actions', `
                        <button onclick="openProjectModal(null, '${currentUser.user_id}')" class="btn btn-primary w-full mb-2">Create New Project</button>
                        <button onclick="openNoticeModal()" class="btn btn-primary w-full">Post Notice</button>
                    `)}
                </div>
            `;
        }

        async function renderSupervisorProjectsPage() {
            const myProjects = await fetchData('projects.php', { supervisor_id: currentUser.user_id });
            const allUsers = await fetchData('users.php');

            let projectCards = '';
            if (myProjects && myProjects.length > 0) {
                projectCards = myProjects.map(project => {
                     const leader = project.leader ? project.leader : null;
                     const studentNames = project.members ? project.members.map(member => {
                        return `${member.name}${member.is_leader ? ' <span class="text-xs bg-green-100 text-green-700 px-1 rounded-full">Leader</span>' : ''}`;
                    }).join(', ') : 'No students assigned';

                    return `
                        <div class="bento-box">
                            <h4 class="text-xl font-semibold text-blue-600">${project.title}</h4>
                            <p class="text-sm text-gray-500 mb-1">Semester: ${project.semester || 'N/A'}</p>
                            <p class="text-sm text-gray-500 mb-1">Leader: ${leader ? leader.name : 'Not Set'}</p>
                            <p class="text-sm text-gray-600 mb-2 h-12 overflow-y-auto">${project.description}</p>
                            <p class="text-sm text-gray-500 mb-1">Status: <span class="font-medium ${project.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'}">${project.status}</span></p>
                            <p class="text-xs text-gray-500 mb-3">Team: ${studentNames}</p>
                            <div class="flex justify-between items-center mt-3">
                                <div>
                                    <button onclick="openAssignStudentsModal('${project.project_id}')" class="text-sm btn bg-green-500 hover:bg-green-600 text-white py-1 px-3 mr-2">Manage Team</button>
                                </div>
                                <div class="space-x-2">
                                    <button onclick="openProjectModal('${project.project_id}')" class="text-sm btn btn-secondary py-1 px-3">Edit Project</button>
                                    <button onclick="deleteProject('${project.project_id}')" class="text-sm btn btn-danger py-1 px-3">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                projectCards = `<p class="text-center py-4 text-gray-500 col-span-full">You have not created or been assigned any projects.</p>`;
            }
            document.getElementById('mainContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">My Projects</h1>
                    <button onclick="openProjectModal(null, '${currentUser.user_id}')" class="btn btn-primary">Create New Project</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${projectCards}
                </div>
            `;
        }
        
        async function renderSupervisorStudentsPage() {
            const myProjects = await fetchData('projects.php', { supervisor_id: currentUser.user_id });
            const allUsers = await fetchData('users.php');

            const supervisedStudentIds = new Set();
            if (myProjects) {
                myProjects.forEach(p => {
                    if (p.members) p.members.forEach(m => supervisedStudentIds.add(m.user_id));
                });
            }
            const supervisedStudents = allUsers ? allUsers.filter(u => supervisedStudentIds.has(u.user_id)) : [];

            let tableRows = '';
            if (supervisedStudents.length > 0) {
                tableRows = supervisedStudents.map(student => {
                    const project = myProjects ? myProjects.find(p => p.members.some(m => m.user_id === student.user_id)) : null; // Find the project this student is part of
                    return `
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <td class="py-3 px-4 text-sm text-gray-700">${student.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-700">${student.email}</td>
                        <td class="py-3 px-4 text-sm text-gray-700">${student.roll_number || 'N/A'}</td>
                        <td class="py-3 px-4 text-sm text-gray-700">${student.semester || 'N/A'}</td>
                        <td class="py-3 px-4 text-sm text-gray-700">${project ? project.title : 'N/A'}</td>
                        <td class="py-3 px-4 text-sm">
                            <button onclick="openUserModal('${student.user_id}')" class="text-blue-600 hover:text-blue-800 font-medium mr-2">Edit</button>
                            <button onclick="deleteUser('${student.user_id}')" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
                        </td>
                    </tr>
                `}).join('');
            } else {
                tableRows = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No students are currently assigned to your projects.</td></tr>`;
            }

            document.getElementById('mainContent').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">My Students</h1>
                    <button onclick="openUserModal(null, 'student')" class="btn btn-primary">Add New Student</button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Semester</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                                <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        async function renderSupervisorSubmissionsPage() {
            const myProjects = await fetchData('projects.php', { supervisor_id: currentUser.user_id });
            const allSubmissions = await fetchData('submissions.php'); // Fetch all submissions
            const allUsers = await fetchData('users.php');

            let submissionsToReview = [];
            if (myProjects && allSubmissions) {
                const myProjectIds = myProjects.map(p => p.project_id);
                submissionsToReview = allSubmissions.filter(s => myProjectIds.includes(s.project_id));
            }

            let submissionItems = '';
            if (submissionsToReview.length > 0) {
                submissionItems = submissionsToReview.map(sub => {
                    const project = myProjects ? myProjects.find(p => p.project_id === sub.project_id) : null;
                    const student = allUsers ? allUsers.find(u => u.user_id === sub.student_id) : null;
                    return `
                        <div class="bento-box mb-4">
                            <h4 class="text-lg font-semibold">${sub.file_name}</h4>
                            <p class="text-sm text-gray-600">Project: ${project?.title || 'N/A'} (Semester: ${project?.semester || 'N/A'})</p>
                            <p class="text-sm text-gray-600">Student: ${student?.name || 'N/A'} (Roll: ${student?.roll_number || 'N/A'})</p>
                            <p class="text-sm text-gray-500">Submitted: ${new Date(sub.submission_date).toLocaleDateString()}</p>
                            <p class="text-sm">Status: <span class="font-medium ${sub.status === 'Reviewed' ? 'text-green-600' : 'text-orange-500'}">${sub.status}</span></p>
                            ${sub.feedback ? `<p class="text-sm text-gray-700 mt-2 p-2 bg-gray-100 rounded whitespace-pre-wrap">Feedback: ${sub.feedback}</p>` : ''}
                            <div class="mt-3 flex items-center">
                                <a href="${API_BASE_URL}submissions.php?action=download&file=${sub.file_name}" target="_blank" class="btn btn-secondary text-sm py-1 px-3 mr-2">Download File</a>
                                ${sub.status === 'Submitted' ? `
                                    <textarea id="feedback-${sub.submission_id}" class="input-field flex-grow mr-2" rows="2" placeholder="Enter feedback..."></textarea>
                                    <button onclick="submitFeedback('${sub.submission_id}')" class="btn btn-primary text-sm py-1 px-3">Submit Feedback</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                submissionItems = `<p class="text-center py-4 text-gray-500">No submissions to review at this time.</p>`;
            }

            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Review Submissions</h1>
                <div>${submissionItems}</div>
            `;
        }

        // --- Student Specific Pages ---
        async function renderStudentDashboard() {
            const myProjects = await fetchData('projects.php', { student_id: currentUser.user_id });
            const myProject = myProjects && myProjects.length > 0 ? myProjects[0] : null; // Assuming a student has one project
            const mySubmissions = await fetchData('submissions.php', { student_id: currentUser.user_id });
            const allNotices = await fetchData('notices.php');
            const allUsers = await fetchData('users.php');
            const allProjects = await fetchData('projects.php');
            const allSemesters = await fetchData('semesters.php');


            const mySubmissionsCount = mySubmissions ? mySubmissions.length : 0;
            
            const relevantNoticesCount = allNotices ? allNotices.filter(n => {
                const aud = { type: n.audience_type, targetId: n.target_id };
                if (aud.type === 'all') return true;
                if (aud.type === 'all_students') return true;
                if (aud.type === 'specific_student' && aud.targetId === currentUser.user_id) return true;
                if (aud.type === 'specific_project' && myProject && myProject.project_id === aud.targetId) return true;
                if (aud.type === 'specific_semester_students') {
                    const studentUser = allUsers.find(u => u.user_id === currentUser.user_id);
                    return studentUser && studentUser.semester === aud.targetId;
                }
                return false;
            }).length : 0;


            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">Student Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${createBentoBox('My Project', myProject ? `
                        <h4 class="font-semibold text-blue-600">${myProject.title}</h4>
                        <p class="text-sm text-gray-500">Semester: ${myProject.semester || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${myProject.description.substring(0,80)}...</p>
                        <p class="text-sm text-gray-500 mt-1">Status: ${myProject.status}</p>
                        ${myProject.leader && myProject.leader.user_id === currentUser.user_id ? '<p class="text-xs mt-1 font-semibold text-green-600">You are the Project Leader</p>' : ''}
                        <button onclick="navigateTo('studentProject')" class="text-sm text-blue-600 hover:underline mt-2">View Project Details &rarr;</button>
                    ` : '<p class="text-gray-600">You are not assigned to any project yet.</p>')}
                    ${createBentoBox('My Submissions', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${mySubmissionsCount}</span> Total Submissions</p>
                        <button onclick="navigateTo('studentSubmissions')" class="text-sm text-blue-600 hover:underline mt-2">View My Submissions &rarr;</button>
                    `)}
                    ${createBentoBox('Relevant Notices', `
                        <p class="text-gray-600"><span class="font-bold text-2xl text-blue-600">${relevantNoticesCount}</span> Notices for you</p>
                         <button onclick="navigateTo('viewNotices')" class="text-sm text-blue-600 hover:underline mt-2">View All Notices &rarr;</button>
                    `)}
                </div>
            `;
        }

        async function renderStudentProjectPage() {
            const myProjects = await fetchData('projects.php', { student_id: currentUser.user_id });
            const myProject = myProjects && myProjects.length > 0 ? myProjects[0] : null;

            if (!myProject) return document.getElementById('mainContent').innerHTML = `<h1 class="text-2xl font-semibold">My Project</h1><p>You are not currently assigned to a project.</p>`;
            
            const supervisor = await fetchData('users.php', { id: myProject.supervisor_id });
            const projectSupervisor = supervisor ? supervisor[0] : null;
            const leader = myProject.leader ? myProject.leader : null; // Leader is already part of project object from API
            const teamMembers = myProject.members ? myProject.members.map(member => {
                return `${member.name}${member.is_leader ? ' <span class="text-xs bg-green-100 text-green-700 px-1 py-0.5 rounded-full">Leader</span>' : ''}`;
            }).join(', ') : 'No team members assigned.';

            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">My Project: ${myProject.title}</h1>
                <div class="bento-box">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Project Details</h3>
                    <p class="text-gray-600 mb-1"><strong class="text-gray-600">Semester:</strong> ${myProject.semester || 'N/A'}</p>
                    <p class="text-gray-600 mb-4 whitespace-pre-wrap">${myProject.description}</p>
                    <p><strong class="text-gray-600">Supervisor:</strong> ${projectSupervisor ? projectSupervisor.name : 'N/A'}</p>
                    <p><strong class="text-gray-600">Leader:</strong> ${leader ? leader.name : 'Not Set'}</p>
                    <p><strong class="text-gray-600">Status:</strong> <span class="font-medium ${myProject.status === 'Completed' ? 'text-green-600' : 'text-yellow-600'}">${myProject.status}</span></p>
                    <p class="mt-2"><strong class="text-gray-600">Team Members:</strong> ${teamMembers}</p>
                </div>
                <div class="bento-box mt-6">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Submit Work</h3>
                    <form id="submissionForm" class="space-y-3">
                        <div>
                            <label for="submissionFile" class="block text-sm font-medium text-gray-700">Upload File</label>
                            <input type="file" id="submissionFile" name="submissionFile" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            `;
        }

        async function renderStudentSubmissionsPage() {
            const mySubmissions = await fetchData('submissions.php', { student_id: currentUser.user_id });
            const allProjects = await fetchData('projects.php');

            let submissionItems = '';
            if (mySubmissions && mySubmissions.length > 0) {
                submissionItems = mySubmissions.map(sub => {
                    const project = allProjects ? allProjects.find(p => p.project_id === sub.project_id) : null;
                    return `
                        <div class="bento-box mb-4">
                            <h4 class="text-lg font-semibold">${sub.file_name}</h4>
                            <p class="text-sm text-gray-600">Project: ${project?.title || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Submitted: ${new Date(sub.submission_date).toLocaleDateString()}</p>
                            <p class="text-sm">Status: <span class="font-medium ${sub.status === 'Reviewed' ? 'text-green-600' : (sub.status === 'Submitted' ? 'text-orange-500' : 'text-gray-500')}">${sub.status}</span></p>
                            ${sub.feedback ? `<div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                                <h5 class="font-semibold text-sm text-blue-700">Feedback:</h5>
                                                <p class="text-sm text-blue-600 whitespace-pre-wrap">${sub.feedback}</p>
                                             </div>` 
                                           : (sub.status === 'Reviewed' ? '<p class="text-sm text-gray-500 mt-2">No specific feedback provided.</p>' : '')}
                            <div class="mt-3">
                                <a href="${API_BASE_URL}submissions.php?action=download&file=${sub.file_name}" target="_blank" class="btn btn-secondary text-sm py-1 px-3">Download File</a>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                submissionItems = `<p class="text-center py-4 text-gray-500">You have not made any submissions yet.</p>`;
            }
            document.getElementById('mainContent').innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-gray-800">My Submissions</h1>
                <div>${submissionItems}</div>
            `;
        }
        // --- DASHBOARD AND MANAGEMENT PAGE RENDERING END ---


        // --- MODAL HANDLING START ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'noticeModal') {
                 document.getElementById('noticeSpecificTargetContainer').style.display = 'none';
                 document.getElementById('noticeStudentFilter').style.display = 'none';
                 document.getElementById('noticeStudentFilter').value = '';
            }
        }
        
        function showMessageModal(title, message) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalText').textContent = message;
            openModal('messageModal');
        }
        
        function toggleStudentFields() {
            const role = document.getElementById('userRole').value;
            const studentFields = document.getElementById('studentSpecificFields');
            if (role === 'student') {
                studentFields.style.display = 'grid'; 
            } else {
                studentFields.style.display = 'none';
            }
        }

        async function populateSemesterDropdown(selectElementId, selectedSemester = null) {
            const selectEl = document.getElementById(selectElementId);
            selectEl.innerHTML = '<option value="">Select Semester</option>'; // Default empty option
            const semesters = await fetchData('semesters.php'); // Fetch from API

            if (semesters) {
                semesters.forEach(sem => {
                    const option = document.createElement('option');
                    option.value = sem.semester_name;
                    option.textContent = sem.semester_name;
                    if (sem.semester_name === selectedSemester) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });
            }
        }

        async function openUserModal(userId = null, defaultRole = 'student') {
            const form = document.getElementById('userForm');
            form.reset();
            document.getElementById('userId').value = '';
            document.getElementById('userRole').value = defaultRole; 
            document.getElementById('userPassword').placeholder = "Leave blank if not changing";
            await populateSemesterDropdown('userSemester'); // Populate semesters

            if (userId) {
                const user = await fetchData('users.php', { id: userId });
                const userData = user ? user[0] : null;
                if (userData) {
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('userId').value = userData.user_id;
                    document.getElementById('userName').value = userData.name;
                    document.getElementById('userEmail').value = userData.email;
                    document.getElementById('userRole').value = userData.role;
                    if (userData.role === 'student') {
                        document.getElementById('userRoll').value = userData.roll_number || '';
                        await populateSemesterDropdown('userSemester', userData.semester); // Repopulate with selected
                    }
                }
            } else {
                document.getElementById('userModalTitle').textContent = 'Create User';
                document.getElementById('userPassword').placeholder = "Required for new user";
            }
            toggleStudentFields(); 
            openModal('userModal');
        }
        
        async function openProjectModal(projectId = null, defaultSupervisorId = null) {
            const form = document.getElementById('projectForm');
            form.reset();
            document.getElementById('projectId').value = '';
            await populateSemesterDropdown('projectSemester'); // Populate semesters

            const supervisorSelect = document.getElementById('projectSupervisor');
            supervisorSelect.innerHTML = '<option value="">Select Supervisor</option>'; 
            const supervisors = await fetchData('users.php', { role: 'supervisor' });
            if (supervisors) {
                supervisors.forEach(sup => {
                    const option = document.createElement('option');
                    option.value = sup.user_id;
                    option.textContent = sup.name;
                    supervisorSelect.appendChild(option);
                });
            }
            
            if (currentUser.role === 'supervisor' && !defaultSupervisorId) {
                 supervisorSelect.value = currentUser.user_id;
            } else if (defaultSupervisorId) {
                 supervisorSelect.value = defaultSupervisorId;
            }

            if (projectId) {
                const project = await fetchData('projects.php', { id: projectId });
                const projectData = project ? project[0] : null;
                if (projectData) {
                    document.getElementById('projectModalTitle').textContent = 'Edit Project';
                    document.getElementById('projectId').value = projectData.project_id;
                    document.getElementById('projectTitle').value = projectData.title;
                    document.getElementById('projectDescription').value = projectData.description;
                    await populateSemesterDropdown('projectSemester', projectData.semester);
                    if (projectData.supervisor_id) supervisorSelect.value = projectData.supervisor_id;
                }
            } else {
                document.getElementById('projectModalTitle').textContent = 'Create Project';
            }
            openModal('projectModal');
        }
        
        async function updateNoticeTargetOptions(audienceType = null, isFiltering = false) {
            if (!audienceType) {
                audienceType = document.getElementById('noticeAudienceType').value;
            }
            const targetContainer = document.getElementById('noticeSpecificTargetContainer');
            const targetSelect = document.getElementById('noticeSpecificTarget');
            const targetLabel = document.getElementById('noticeSpecificTargetLabel');
            const studentFilterInput = document.getElementById('noticeStudentFilter');
            
            if (!isFiltering) {
                targetSelect.innerHTML = ''; 
            }

            let options = [];
            let showTargetSelect = false;
            studentFilterInput.style.display = 'none';

            switch (audienceType) {
                case 'specific_student':
                    targetLabel.textContent = 'Select Student';
                    studentFilterInput.style.display = 'block';
                    const filterText = studentFilterInput.value.toLowerCase();
                    const students = await fetchData('users.php', { role: 'student' });
                    options = students ? students.filter(u => 
                                                (u.name.toLowerCase().includes(filterText) || (u.roll_number && u.roll_number.toLowerCase().includes(filterText))))
                                     .map(s => ({ value: s.user_id, text: `${s.name} (${s.roll_number || 'N/A'}) - ${s.semester}` })) : [];
                    showTargetSelect = true;
                    break;
                case 'specific_supervisor':
                    targetLabel.textContent = 'Select Supervisor';
                    const supervisors = await fetchData('users.php', { role: 'supervisor' });
                    options = supervisors ? supervisors.map(s => ({ value: s.user_id, text: s.name })) : [];
                    showTargetSelect = true;
                    break;
                case 'specific_project':
                    targetLabel.textContent = 'Select Project/Team';
                    const projects = await fetchData('projects.php');
                    options = projects ? projects.map(p => ({ value: p.project_id, text: `${p.title} (Sem: ${p.semester || 'N/A'})` })) : [];
                    showTargetSelect = true;
                    break;
                case 'specific_semester_students':
                    targetLabel.textContent = 'Select Semester';
                    const semesters = await fetchData('semesters.php');
                    options = semesters ? semesters.map(sem => ({ value: sem.semester_name, text: sem.semester_name })) : [];
                    showTargetSelect = true;
                    break;
                default: 
                    showTargetSelect = false;
                    break;
            }
            
            if (!isFiltering || targetSelect.options.length === 0 || audienceType !== 'specific_student') {
                targetSelect.innerHTML = '';
                 if (options.length > 0) {
                    options.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt.value;
                        optionEl.textContent = opt.text;
                        targetSelect.appendChild(optionEl);
                    });
                } else {
                     const optionEl = document.createElement('option');
                     optionEl.textContent = 'No targets available';
                     optionEl.disabled = true;
                     targetSelect.appendChild(optionEl);
                }
            } else if (audienceType === 'specific_student' && isFiltering) {
                const currentSelectedValue = targetSelect.value;
                targetSelect.innerHTML = '';
                 if (options.length > 0) {
                    options.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt.value;
                        optionEl.textContent = opt.text;
                        if(opt.value === currentSelectedValue) optionEl.selected = true;
                        targetSelect.appendChild(optionEl);
                    });
                } else {
                     const optionEl = document.createElement('option');
                     optionEl.textContent = 'No students match filter';
                     optionEl.disabled = true;
                     targetSelect.appendChild(optionEl);
                }
            }

            if (showTargetSelect) {
                targetContainer.style.display = 'block';
            } else {
                targetContainer.style.display = 'none';
            }
        }

        async function openNoticeModal(noticeId = null) {
            const form = document.getElementById('noticeForm');
            form.reset();
            document.getElementById('noticeId').value = '';
            document.getElementById('noticeStudentFilter').value = '';
            document.getElementById('noticeStudentFilter').style.display = 'none';
            await updateNoticeTargetOptions(); // Initial population

            if (noticeId) {
                const notice = await fetchData('notices.php', { id: noticeId });
                const noticeData = notice ? notice[0] : null;
                if (noticeData) {
                    document.getElementById('noticeModalTitle').textContent = 'Edit Notice';
                    document.getElementById('noticeId').value = noticeData.notice_id;
                    document.getElementById('noticeTitle').value = noticeData.title;
                    document.getElementById('noticeContent').value = noticeData.content;
                    document.getElementById('noticeAudienceType').value = noticeData.audience_type;
                    await updateNoticeTargetOptions(noticeData.audience_type); // Repopulate targets based on loaded type
                    if (noticeData.target_id) {
                        document.getElementById('noticeSpecificTarget').value = noticeData.target_id;
                    }
                }
            } else {
                document.getElementById('noticeModalTitle').textContent = 'Post New Notice';
            }
            openModal('noticeModal');
        }
        // --- MODAL HANDLING END ---


        // --- CRUD OPERATIONS START ---

        // User Form Submission Handler
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            const roll_number = document.getElementById('userRoll').value;
            const semester = document.getElementById('userSemester').value;

            const userData = { name, email, role };
            if (password) userData.password = password;
            if (role === 'student') {
                userData.roll_number = roll_number;
                userData.semester = semester;
            } else {
                userData.roll_number = null; // Clear if not a student
                userData.semester = null;    // Clear if not a student
            }

            let response = null;
            if (id) { 
                userData.user_id = id;
                response = await sendData('users.php', 'PUT', userData);
            } else { 
                response = await sendData('users.php', 'POST', userData);
            }

            if (response) {
                showMessageModal('Success', response.message);
                closeModal('userModal');
                refreshCurrentPage(); 
            }
        });

        // Project Form Submission Handler
        document.getElementById('projectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('projectId').value;
            const title = document.getElementById('projectTitle').value;
            const description = document.getElementById('projectDescription').value;
            const supervisor_id = document.getElementById('projectSupervisor').value;
            const semester = document.getElementById('projectSemester').value;
            const status = 'Planning'; // Default status for new projects

            if (!supervisor_id) {
                showMessageModal('Error', 'Please assign a supervisor to the project.');
                return;
            }
            if (!semester) {
                showMessageModal('Error', 'Please select a semester for the project.');
                return;
            }

            const projectData = { title, description, supervisor_id, semester, status };

            let response = null;
            if (id) { 
                projectData.project_id = id;
                response = await sendData('projects.php', 'PUT', projectData);
            } else { 
                response = await sendData('projects.php', 'POST', projectData);
            }

            if (response) {
                showMessageModal('Success', response.message);
                closeModal('projectModal');
                refreshCurrentPage();
            }
        });

        // Notice Form Submission Handler
        document.getElementById('noticeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('noticeId').value;
            const title = document.getElementById('noticeTitle').value;
            const content = document.getElementById('noticeContent').value;
            const audience_type = document.getElementById('noticeAudienceType').value;
            const specificTargetEl = document.getElementById('noticeSpecificTarget');
            const target_id = specificTargetEl.value;
            
            const noticeData = { title, content, audience_type, author_id: currentUser.user_id };

            if (['specific_student', 'specific_supervisor', 'specific_project', 'specific_semester_students'].includes(audience_type)) {
                if (!target_id && specificTargetEl.options.length > 0 && !specificTargetEl.options[0].disabled) {
                    showMessageModal('Error', 'Please select a specific target for this audience type.');
                    return;
                } else if (specificTargetEl.options.length === 0 || specificTargetEl.options[0].disabled) {
                     showMessageModal('Error', 'No valid targets available for the selected audience type.');
                    return;
                }
                noticeData.target_id = target_id;
            } else {
                noticeData.target_id = null; // Ensure target_id is null for 'all' types
            }

            let response = null;
            if (id) { 
                noticeData.notice_id = id;
                response = await sendData('notices.php', 'PUT', noticeData);
            } else { 
                response = await sendData('notices.php', 'POST', noticeData);
            }

            if (response) {
                showMessageModal('Success', response.message);
                closeModal('noticeModal');
                refreshCurrentPage();
            }
        });
        
        // Student Submission File Handler
        async function handleStudentSubmission(e) { 
            e.preventDefault();
            const fileInput = document.getElementById('submissionFile');
            const myProjects = await fetchData('projects.php', { student_id: currentUser.user_id });
            const myProject = myProjects && myProjects.length > 0 ? myProjects[0] : null;

            if (!myProject) {
                 showMessageModal('Error', 'You are not assigned to a project. Cannot submit.');
                 return;
            }

            if (fileInput.files.length === 0) {
                 showMessageModal('Error', 'Please select a file to submit.');
                 return;
            }

            const formData = new FormData();
            formData.append('projectId', myProject.project_id);
            formData.append('studentId', currentUser.user_id);
            formData.append('submissionFile', fileInput.files[0]);

            const response = await sendData('submissions.php', 'POST', formData, true); // true for FormData

            if (response) {
                showMessageModal('Success', response.message);
                e.target.reset(); 
                refreshCurrentPage(); 
            }
        }

        // Delete User
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            const response = await sendData('users.php', 'DELETE', { user_id: userId });
            if (response) {
                showMessageModal('Success', response.message);
                refreshCurrentPage();
            }
        }
        
        // Delete Project
        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project and all associated data (members, submissions)?')) return;
            const response = await sendData('projects.php', 'DELETE', { project_id: projectId });
            if (response) {
                showMessageModal('Success', response.message);
                refreshCurrentPage();
            }
        }

        // Delete Notice
        async function deleteNotice(noticeId) {
            if (!confirm('Are you sure you want to delete this notice?')) return;
            const response = await sendData('notices.php', 'DELETE', { notice_id: noticeId });
            if (response) {
                showMessageModal('Success', response.message);
                refreshCurrentPage();
            }
        }
        
        // Submit Feedback (for supervisors)
        async function submitFeedback(submissionId) {
            const feedbackText = document.getElementById(`feedback-${submissionId}`).value;
            if (feedbackText.trim() === "") {
                showMessageModal('Info', 'Please enter some feedback.');
                return;
            }
            const response = await sendData('submissions.php', 'PUT', {
                submission_id: submissionId,
                status: 'Reviewed',
                feedback: feedbackText.trim()
            });
            if (response) {
                showMessageModal('Success', response.message);
                refreshCurrentPage();
            }
        }
        // --- CRUD OPERATIONS END ---


        // --- TEAM MANAGEMENT LOGIC START ---
        async function openAssignStudentsModal(projectId) {
            const project = await fetchData('projects.php', { id: projectId });
            const projectData = project ? project[0] : null;

            if (!projectData) {
                showMessageModal('Error', 'Project not found.');
                return;
            }

            document.getElementById('assignTeamProjectId').value = projectId;
            document.getElementById('assignTeamModalTitle').textContent = `Manage Team: ${projectData.title}`;

            const currentTeamList = document.getElementById('currentTeamMembersList');
            const availableStudentsList = document.getElementById('availableStudentsList');
            currentTeamList.innerHTML = '';
            availableStudentsList.innerHTML = '';

            const allStudents = await fetchData('users.php', { role: 'student' });

            // Populate current team members
            if (projectData.members && projectData.members.length > 0) {
                projectData.members.forEach(member => {
                    const li = document.createElement('li');
                    li.className = 'list-item';
                    li.innerHTML = `
                        <span>${member.name} (${member.roll_number || 'N/A'}) ${member.is_leader ? '<span class="text-xs bg-green-100 text-green-700 px-1 rounded-full ml-1">Leader</span>' : ''}</span>
                        <div class="list-item-action">
                            ${!member.is_leader ? `<button type="button" onclick="setProjectLeader('${projectId}', '${member.user_id}')" class="text-xs btn btn-primary py-1 px-2">Set Leader</button>` : ''}
                            <button type="button" onclick="removeStudentFromProject('${projectId}', '${member.user_id}')" class="text-xs btn btn-danger py-1 px-2">Remove</button>
                        </div>
                    `;
                    currentTeamList.appendChild(li);
                });
            } else {
                currentTeamList.innerHTML = '<p class="text-sm text-gray-500 p-2">No students currently in this team.</p>';
            }

            // Populate available students (same semester, not in any project)
            const assignedStudentIds = new Set(projectData.members ? projectData.members.map(m => m.user_id) : []);
            const available = allStudents ? allStudents.filter(u => 
                u.semester === projectData.semester && !u.project_id && !assignedStudentIds.has(u.user_id)
            ) : [];

            if (available.length > 0) {
                available.forEach(student => {
                     const li = document.createElement('li');
                     li.className = 'list-item';
                     li.innerHTML = `
                        <span>${student.name} (${student.roll_number || 'N/A'})</span>
                        <button type="button" onclick="addStudentToProject('${projectId}', '${student.user_id}')" class="text-xs btn btn-primary py-1 px-2">Add to Team</button>
                     `;
                     availableStudentsList.appendChild(li);
                });
            } else {
                availableStudentsList.innerHTML = '<p class="text-sm text-gray-500 p-2">No available students in this semester or all are assigned.</p>';
            }
            openModal('assignTeamModal');
        }

        async function setProjectLeader(projectId, studentId) {
            const project = await fetchData('projects.php', { id: projectId });
            const projectData = project ? project[0] : null;

            if (projectData) {
                const updatedMembers = projectData.members.map(member => ({
                    user_id: member.user_id,
                    is_leader: member.user_id === studentId // Set this student as leader, others as not
                }));
                const response = await sendData('projects.php', 'PUT', {
                    project_id: projectId,
                    title: projectData.title, // Keep existing data
                    description: projectData.description,
                    supervisor_id: projectData.supervisor_id,
                    status: projectData.status,
                    semester: projectData.semester,
                    members: updatedMembers // Send updated members array
                });

                if (response) {
                    showMessageModal('Success', `${(await fetchData('users.php', {id: studentId}))[0].name} is now the project leader.`);
                    await openAssignStudentsModal(projectId); // Refresh modal content
                    refreshCurrentPage(); // Refresh main page view if leader is shown there
                }
            }
        }

        async function addStudentToProject(projectId, studentId) {
            const project = await fetchData('projects.php', { id: projectId });
            const projectData = project ? project[0] : null;
            const student = (await fetchData('users.php', { id: studentId }))[0];

            if (projectData && student && !projectData.members.some(m => m.user_id === studentId)) {
                const updatedMembers = projectData.members.map(member => ({...member})); // Copy existing members
                updatedMembers.push({ user_id: studentId, is_leader: false }); // Add new student as non-leader

                const response = await sendData('projects.php', 'PUT', {
                    project_id: projectId,
                    title: projectData.title,
                    description: projectData.description,
                    supervisor_id: projectData.supervisor_id,
                    status: projectData.status,
                    semester: projectData.semester,
                    members: updatedMembers
                });

                if (response) {
                    // Update the student's project_id in the users table
                    await sendData('users.php', 'PUT', {
                        user_id: studentId,
                        name: student.name,
                        email: student.email,
                        role: student.role,
                        roll_number: student.roll_number,
                        semester: student.semester,
                        project_id: projectId // Add project_id to student's record
                    });
                    showMessageModal('Success', `${student.name} added to project.`);
                    await openAssignStudentsModal(projectId); // Refresh modal content
                    refreshCurrentPage();
                }
            }
        }

        async function removeStudentFromProject(projectId, studentId) {
            const project = await fetchData('projects.php', { id: projectId });
            const projectData = project ? project[0] : null;
            const student = (await fetchData('users.php', { id: studentId }))[0];

            if (projectData && student) {
                const updatedMembers = projectData.members.filter(member => member.user_id !== studentId);

                const response = await sendData('projects.php', 'PUT', {
                    project_id: projectId,
                    title: projectData.title,
                    description: projectData.description,
                    supervisor_id: projectData.supervisor_id,
                    status: projectData.status,
                    semester: projectData.semester,
                    members: updatedMembers
                });

                if (response) {
                    // Update the student's project_id in the users table
                    await sendData('users.php', 'PUT', {
                        user_id: studentId,
                        name: student.name,
                        email: student.email,
                        role: student.role,
                        roll_number: student.roll_number,
                        semester: student.semester,
                        project_id: null // Remove project_id from student's record
                    });
                    showMessageModal('Success', `${student.name} removed from project.`);
                    await openAssignStudentsModal(projectId); // Refresh modal content
                    refreshCurrentPage();
                }
            }
        }
        // --- TEAM MANAGEMENT LOGIC END ---


        // --- INITIALIZATION AND EVENT LISTENERS START ---
        // This function is called when the entire page is loaded.
        window.onload = () => {
            loadCurrentUser(); // Attempt to load user from localStorage
            renderSidebar(); // Render sidebar based on loaded user (or show login if no user)

            // Attach global event listener for the notice student filter input
            const studentFilterInput = document.getElementById('noticeStudentFilter');
            if (studentFilterInput) {
                studentFilterInput.addEventListener('input', () => {
                    updateNoticeTargetOptions(document.getElementById('noticeAudienceType').value, true);
                });
            }
        };
        // --- INITIALIZATION AND EVENT LISTENERS END ---
    </script>
</body>
</html>
